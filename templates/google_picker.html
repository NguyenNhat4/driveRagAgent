<!--
Copyright 2018 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!-- [START picker_hello_world] -->
<!DOCTYPE html>
<html>
<head>
  <title>Google Picker API Quickstart</title>
  <meta charset="utf-8" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .hidden { display: none; }
    #result-box {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .copy-btn {
      margin-left: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    code {
        background: #eee;
        padding: 4px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 1.1em;
    }
    .error {
      color: red;
      padding: 10px;
      border: 1px solid red;
      background-color: #ffeeee;
      border-radius: 5px;
      margin-top: 10px;
    }
    .info {
      background-color: #e8f0fe;
      color: #1967d2;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
<h3>Select a Folder from Google Drive</h3>

<div class="info">
  <strong>Configuration Helper:</strong><br>
  Current Origin: <code id="current-origin"></code><br>
  <small>Ensure this origin is added to "Authorized JavaScript origins" in your Google Cloud Console for the OAuth Client ID.</small>
</div>

<!--Add buttons to initiate auth sequence and sign out.-->
<button id="authorize_button" onclick="handleAuthClick()" class="hidden">Authorize & Open Picker</button>
<button id="signout_button" onclick="handleSignoutClick()" class="hidden">Sign Out</button>

<div id="error-box" class="error hidden"></div>

<div id="result-box" class="hidden">
  <p><strong>Selected Folder ID:</strong></p>
  <p>
      <code id="folder-id"></code>
      <button class="copy-btn" onclick="copyToClipboard()">Copy ID</button>
  </p>
  <p><small>Paste this ID into the "Folder ID" field in the main app.</small></p>
  <p><strong>Folder Name:</strong> <span id="folder-name"></span></p>
</div>

<pre id="content" style="white-space: pre-wrap; display:none;"></pre>

<script type="text/javascript">
  /* exported gapiLoaded */
  /* exported gisLoaded */
  /* exported handleAuthClick */
  /* exported handleSignoutClick */

  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

  // These values are injected by the Python backend
  const CLIENT_ID = '{client_id}';
  const API_KEY = '{api_key}';
  const APP_ID = '{app_id}';

  let tokenClient;
  let accessToken = null;
  let pickerInited = false;
  let gisInited = false;

  // Display current origin immediately
  document.getElementById('current-origin').innerText = window.location.origin;

  function showError(msg) {
      const el = document.getElementById('error-box');
      el.innerText = "Error: " + msg;
      el.classList.remove('hidden');

      if (msg.includes("invalid_request") || msg.includes("origin_mismatch")) {
          const origin = window.location.origin;
          el.innerHTML += `<br><br><strong>Tip:</strong> This error usually means the URL <code>${origin}</code> is not listed in the "Authorized JavaScript origins" of your OAuth Client ID in the Google Cloud Console.`;
      }
  }

  /**
   * Callback after api.js is loaded.
   */
  function gapiLoaded() {
    gapi.load('client:picker', initializePicker);
  }

  /**
   * Callback after the API client is loaded. Loads the
   * discovery doc to initialize the API.
   */
  async function initializePicker() {
    await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
    pickerInited = true;
    maybeEnableButtons();
  }

  /**
   * Callback after Google Identity Services are loaded.
   */
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', // defined later
    });
    gisInited = true;
    maybeEnableButtons();
  }

  /**
   * Enables user interaction after all libraries are loaded.
   */
  function maybeEnableButtons() {
    if (pickerInited && gisInited) {
      document.getElementById('authorize_button').classList.remove('hidden');
    }
  }

  /**
   *  Sign in the user upon button click.
   */
  function handleAuthClick() {
    document.getElementById('error-box').classList.add('hidden'); // Clear previous errors

    tokenClient.callback = async (response) => {
      if (response.error !== undefined) {
        console.error("Auth Error:", response);
        showError(JSON.stringify(response));
        throw (response);
      }
      accessToken = response.access_token;
      document.getElementById('signout_button').classList.remove('hidden');
      document.getElementById('authorize_button').innerText = 'Open Picker Again';
      await createPicker();
    };

    if (accessToken === null) {
      // Prompt the user to select a Google Account and ask for consent to share their data
      // when establishing a new session.
      tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
      // Skip display of account chooser and consent dialog for an existing session.
      tokenClient.requestAccessToken({prompt: ''});
    }
  }

  /**
   *  Sign out the user upon button click.
   */
  function handleSignoutClick() {
    if (accessToken) {
      google.accounts.oauth2.revoke(accessToken);
      accessToken = null;
      document.getElementById('result-box').classList.add('hidden');
      document.getElementById('authorize_button').innerText = 'Authorize & Open Picker';
      document.getElementById('signout_button').classList.add('hidden');
    }
  }

  /**
   *  Create and render a Google Picker object for selecting folders.
   */
  function createPicker() {
    // Create view for folders
    const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
        .setSelectFolderEnabled(true)
        .setIncludeFolders(true)
        .setMimeTypes('application/vnd.google-apps.folder');
    
    let builder = new google.picker.PickerBuilder()
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        .setDeveloperKey(API_KEY)
        .setOAuthToken(accessToken)
        .addView(view)
        .setCallback(pickerCallback);

    // Only set AppId if it looks valid (e.g., numeric string)
    // or if provided. The API sometimes rejects invalid App IDs.
    if (APP_ID && APP_ID.length > 0) {
        builder.setAppId(APP_ID);
    }

    const picker = builder.build();
    picker.setVisible(true);
  }

  /**
   * Displays the file details of the user's selection.
   * @param {object} data - Contains the user selection from the Google Picker.
   */
  async function pickerCallback(data) {
    if (data.action === google.picker.Action.PICKED) {
      const document = data[google.picker.Response.DOCUMENTS][0];
      const fileId = document[google.picker.Document.ID];
      const fileName = document[google.picker.Document.NAME];

      const folderIdEl = window.document.getElementById('folder-id');
      const folderNameEl = window.document.getElementById('folder-name');
      const resultBox = window.document.getElementById('result-box');

      folderIdEl.innerText = fileId;
      folderNameEl.innerText = fileName;
      resultBox.classList.remove('hidden');
    }
  }

  function copyToClipboard() {
      const copyText = document.getElementById("folder-id");
      navigator.clipboard.writeText(copyText.innerText).then(() => {
          alert("ID copied to clipboard!");
      });
  }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
<!-- [END picker_hello_world] -->
